const N=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&i(l)}).observe(document,{childList:!0,subtree:!0});function o(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerpolicy&&(a.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?a.credentials="include":n.crossorigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(n){if(n.ep)return;n.ep=!0;const a=o(n);fetch(n.href,a)}};N();const s={car:{width:31*3,height:81*3,color:"#E8D8B9",offset:100,maxSteering:.01,acceleration:.1,deceleration:.2},physics:{timeBetweenSteps:1e3/60*1,rays:{count:5,offset:.1,range:500,stepSize:.1},granularity:10,speedFalloff:.01},renderer:{rays:{length:500,colorHit:"#E0403F",colorMiss:"#234"},map:{hillColor:"#424A28",hillTopColor:"#282C34",checkerBoardColorA:"#456",checkerBoardColorB:"#567"}}},T={rayDegrees:[...Array(s.physics.rays.count).keys()].map(e=>(e-s.physics.rays.count/2+.5)*s.physics.rays.offset)},C=document.getElementById("canvas");let m=window.innerWidth,u=window.innerHeight;C.width=m;C.height=u;const c=C.getContext("2d");c.imageSmoothingEnabled=!1;const O=({direction:e})=>{c.save();const t={x:m/2,y:u/2};c.translate(t.x,t.y),c.rotate(-e),c.translate(-t.x,-t.y),L?c.drawImage(L,t.x-s.car.width/2,t.y-s.car.height/2,s.car.width,s.car.height):(c.fillStyle=s.car.color,c.fillRect(t.x-s.car.width/2,t.y-s.car.height/2,s.car.width,s.car.height)),c.restore()},G=({x:e,y:t})=>{c.fillStyle=s.renderer.map.checkerBoardColorA,c.fillRect(0,0,m,u);const o=100,i=100,n=-e%(i*2),a=-t%(o*2);c.fillStyle=s.renderer.map.checkerBoardColorB;for(let l=-2;l*o<u+2*o;++l)for(let y=-2;y*i<m+2*i;++y)(y+l)%2&&c.fillRect(y*i+n,l*o+a,o,i)},W=(e,{x:t,y:o})=>{const i=s.physics.granularity,n=-t%i,a=-o%i,l=[],y=[];for(let f=-i;f<u+i;f+=i)for(let h=-i;h<m+i;h+=i){const p=t+h-m/2+n,g=o+f-u/2+a,w=e(p,g);w==="Hill"?l.push({x:h+n,y:f+a}):w==="HillTop"&&y.push({x:h+n,y:f+a})}c.beginPath(),c.fillStyle=s.renderer.map.hillColor,l.forEach(({x:f,y:h})=>c.rect(f,h,i,i)),c.fill(),c.closePath(),c.beginPath(),c.fillStyle=s.renderer.map.hillTopColor,y.forEach(({x:f,y:h})=>c.rect(f,h,i,i)),c.fill(),c.closePath()},X=({direction:e},t)=>{const o=Math.cos(e),i=Math.sin(e),n={x:m/2+i*s.car.height/2,y:u/2+o*s.car.height/2};T.rayDegrees.forEach((a,l)=>{const y=e+a*Math.PI+Math.PI,f=Math.cos(y),h=Math.sin(y);c.strokeStyle=s.renderer.rays[t[l]?"colorHit":"colorMiss"],c.beginPath(),c.moveTo(n.x,n.y),c.lineTo(f*0-h*s.renderer.rays.length+n.x,h*0-f*s.renderer.rays.length+n.y),c.stroke()})};let L;const Y=e=>L=e,j=({car:e,rays:t,map:o})=>{G(e),W(o,e),O(e),X(e,t)};window.addEventListener("resize",()=>{console.log("resize"),m=window.innerWidth,u=window.innerHeight,C.width=m,C.height=u});var r={car:{x:0,y:0,direction:Math.PI*.1,steering:0,speed:2,primarySteerDirection:1,primarySteerDirectionLocked:!1},rays:[...Array(s.physics.rays.count).fill(!1)],map:()=>!1};function d(e,t,o){this.x=e,this.y=t,this.z=o}d.prototype.dot2=function(e,t){return this.x*e+this.y*t};d.prototype.dot3=function(e,t,o){return this.x*e+this.y*t+this.z*o};let K=[new d(1,1,0),new d(-1,1,0),new d(1,-1,0),new d(-1,-1,0),new d(1,0,1),new d(-1,0,1),new d(1,0,-1),new d(-1,0,-1),new d(0,1,1),new d(0,-1,1),new d(0,1,-1),new d(0,-1,-1)],b=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],k=new Array(512),P=new Array(512);const U=function(e){e>0&&e<1&&(e*=65536),e=Math.floor(e),e<256&&(e|=e<<8);for(let t=0;t<256;t++){let o;t&1?o=b[t]^e&255:o=b[t]^e>>8&255,k[t]=k[t+256]=o,P[t]=P[t+256]=K[o%12]}};let V=.5*(Math.sqrt(3)-1),I=(3-Math.sqrt(3))/6;const $=function(e,t){let o,i,n,a=(e+t)*V,l=Math.floor(e+a),y=Math.floor(t+a),f=(l+y)*I,h=e-l+f,p=t-y+f,g,w;h>p?(g=1,w=0):(g=0,w=1);let D=h-g+I,A=p-w+I,B=h-1+2*I,E=p-1+2*I;l&=255,y&=255;let z=P[l+k[y]],R=P[l+g+k[y+w]],q=P[l+1+k[y+1]],x=.5-h*h-p*p;x<0?o=0:(x*=x,o=x*x*z.dot2(h,p));let S=.5-D*D-A*A;S<0?i=0:(S*=S,i=S*S*R.dot2(D,A));let M=.5-B*B-E*E;return M<0?n=0:(M*=M,n=M*M*q.dot2(B,E)),70*(o+i+n)},J=({x:e,y:t},o=20)=>![...Array(o**2).keys()].map(i=>[i%o,Math.floor(i/o)]).some(([i,n])=>r.map(e+i*s.physics.granularity,t+n*s.physics.granularity)!=="Street"),Q=()=>{for(;!J({x:r.car.x-s.car.width/2,y:r.car.y-s.car.height/2});)r.car.y-=5*s.physics.granularity},Z=()=>{U(42);const e=(t,o)=>{t/=1024,o/=1024;const i=$(t,o);return i<.4?"Street":i<.6?"Hill":"HillTop"};r.map=e,Q()};Z();const _=()=>{const e={x:r.car.x+Math.sin(r.car.direction)*s.car.height/2,y:r.car.y+Math.cos(r.car.direction)*s.car.height/2},t=T.rayDegrees.map(o=>{const i=r.car.direction+o*Math.PI+Math.PI,n=Math.cos(i),a=Math.sin(i);return ee(e,{x:n*0-a*s.renderer.rays.length+e.x,y:a*0-n*s.renderer.rays.length+e.y})});r.rays=t.map(Boolean)},ee=(e,t)=>{const o={...e},i=t.x-e.x,n=t.y-e.y,a=Math.sqrt(i**2+n**2),l=i/a*s.physics.rays.stepSize,y=n/a*s.physics.rays.stepSize,f=s.physics.rays.range/s.physics.rays.stepSize;for(let h=0;h<f;h++){const{x:p,y:g}=o;if(r.map(p,g)!=="Street")return{x:p,y:g};o.x+=l,o.y+=y}},te=()=>{const{car:e}=r,t=Math.cos(e.direction)*e.speed,o=Math.sin(e.direction)*e.speed;e.x+=o,e.y+=t,e.speed=e.speed*(1-s.physics.speedFalloff)},v=e=>{r.car.primarySteerDirectionLocked||(r.car.primarySteerDirection=e,r.car.primarySteerDirectionLocked=!0)},re=()=>{r.rays[1]&&(r.car.steering+=.001,v(1)),r.rays[3]&&(r.car.steering-=.001,v(-1)),r.rays[0]&&(r.car.steering+=5e-4,v(1)),r.rays[4]&&(r.car.steering-=5e-4,v(-1)),r.rays[2]&&(r.car.steering+=r.car.primarySteerDirection*2e-4),r.rays.every(e=>!e)&&(r.car.steering!==0&&(r.car.steering=r.car.steering>0?Math.max(r.car.steering-5e-4,0):Math.min(r.car.steering+5e-4,0)),r.car.primarySteerDirectionLocked=!1),r.rays[2]?r.car.speed=Math.max(0,r.car.speed-s.car.deceleration):r.car.speed+=s.car.acceleration,r.car.steering>s.car.maxSteering?r.car.steering=s.car.maxSteering:r.car.steering<-s.car.maxSteering&&(r.car.steering=-s.car.maxSteering)},se=()=>{r.car.direction+=r.car.steering},F=()=>{_(),re(),se(),te()};F();setInterval(F,s.physics.timeBetweenSteps);const H=()=>requestAnimationFrame(()=>{j(r),H()});H();const oe=async()=>new Promise(e=>{const t=new Image;t.onload=()=>e(t),t.src="./car.png"}),ie=await oe();Y(ie);
